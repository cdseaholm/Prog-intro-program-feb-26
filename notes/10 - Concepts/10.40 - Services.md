# Services


## Marten example

1. Within your Program.cs, you attach your Services to the builder (builder.AddServiceDefaults).

2. Marten, think Mongoose for MongoDB, where it allows you to use PostgreSQL in an easier and more "modern" way.

Look at the code below from [[C:\Users\Student\class\intro\src\week2\MuddiestMomentSolution\MuddiestMoment.Api\Program.cs]]:


3. We are getting our connection string, doing some set up with the Container, then mapping the endpoints we create like (get, put, delete) before running it.

See [[[HTTP Apis for a closer look at the app.MapStudentEndpoints piece](<10.40.10 - HTTP Apis.md>)]

```
    var builder = WebApplication.CreateBuilder(args);


    var connectionString = builder.Configuration.GetConnectionString("db-mm") ?? throw new Exception("No Connection String");

    // builder.Services.AddTransient
    // builder.Services.AddSingleton -- there will be exactly ONE of these services in memory, and every place that it gets injected will share that same instance. So it better be REALLY good and thread safe, or BAD things will happen.
    // builder.Services.AddScoped<IProvideUserInformation, MartinUserInformationPro3000>();

    builder.Services.AddMarten(config =>
    {
        config.Connection(connectionString);
    }).UseLightweightSessions();

    builder.AddServiceDefaults();
    // Add the services to the container.
    // Learn more about configuring OpenAPI at https://aka.ms/aspnet/openapi
    builder.Services.AddOpenApi();

    // above this is configuration of services (things that own some state and the process around it) that we need in our
    // application.
    builder.Services.AddValidation(); // opting in to services to handle some stuff for you.
    var app = builder.Build();
    // everything here is setting up how we actually handle incoming request and write responses.

    if (app.Environment.IsDevelopment())
    {
        app.MapOpenApi(); // while I'm doing development, I want to GET the document at /openapi/v1.json
        // it will generate this when you ask for it. Slow. But "accurate", right?
    }
    // add the code I am about to write that allows us to handle POST to /student/m

    app.MapStudentEndpoints(); // More explicit - means more "intention revealing"


    app.MapDefaultEndpoints();

    // the api is not up and running (listening for requests until we hit the next line)
    app.Run(); // "blocking loop"
```

## PostgreSQL

- This example is in  C:\Users\Student\class\intro\src\week2\MuddiestMomentSolution\AppHost\AppHost.cs

- Similarly to the Marten example, now we are going to connect directly to a PostgreSQL database 
    1. Create the builder
    2. Add Scalar api ref
        - This is an Interactive API Doc (Think swagger doc)
    3. Add the PostgreSQL server
    4. Add the database within the server
    5. Add the projects you want to "render"
    6. Connect them to a your Gateway.Api
    7. Build and run

    Example: 

```
    using Scalar.Aspire;

    var builder = DistributedApplication.CreateBuilder(args);

    // Infrastructure - "backing services" - what is my app going to need in the environment in which it runs.

    var scalar = builder.AddScalarApiReference();
    // - database - postgres (great support for relational data (rows and columns) and for documents (like mongodb))
    // - identity provider (later)
    var postGres = builder.AddPostgres("db-server")
        .WithLifetime(ContainerLifetime.Persistent); // we have in production a postgres server

    // we are going to need a database on that server for the API

    var mmDb = postGres.AddDatabase("db-mm");



    var mmApi = builder.AddProject<Projects.MuddiestMoment_Api>("mm-api")
        .WithReference(mmDb)
        .WaitFor(mmDb);

    scalar.WithApiReference(mmApi); // Make an api call to get this document and show a UI on it.

    var gateway = builder.AddProject<Projects.Gateway_Api>("gateway")
        .WithReference(mmApi)
        .WaitFor(mmApi);

    var instructorApi = builder.AddProject<Projects.Instructor_Api>("instructor-api");

    scalar.WithApiReference(instructorApi);
    builder.Build().Run();

```