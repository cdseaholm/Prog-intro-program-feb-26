# General Flow for C# APIs

Class used Gateway.API with Aspire and Mertens for Session

## Config

    - Root: ./ = folder for APIs

    1. In ./Program.cs, set up DB connection and mertens connection:

    ```
    var builder = WebApplication.CreateBuilder(args);
    var connectionString = builder.Configuration.GetConnectionString("db-mm") ?? throw new Exception("No Connection String");
    ```

    2. ./Properties/launchSettings.json

        - Settings for localhost set up

    3. ./apiFolder(Students in example)/ApiExtensions.cs

        - Where you assign the routes and connect them to builder:
        ```
            public static class ApiExtensions
            {
                extension(IEndpointRouteBuilder endpoints)
                {
                    // POST /students/moments
                    // GET /student/moments
                    public IEndpointRouteBuilder MapStudentEndpoints() 
                    {
                        // 1 hypocritical 
                        // 2 "slimed" - 
                        var group = endpoints.MapGroup("/student/moments");
                        // if any http post methods come in for /student/moments run this function
                        group.MapPost("", StudentAddsMoment.AddMoment);
                        group.MapGet("", StudentGetsListOfSavedMoments.GetAllMomentsForStudent);
                        // DELETE /student/moments/???
                        group.MapDelete("/{id:guid}", StudentMarksMomentAnswered.MarkQuestionAnswered);


                        // TODO /student/answered-questions
                        return group;
                    }
                }
            }
        ```

## Create Routes

    1. Example of a route using async Task, describing the object, and else:

    ```
    using Marten;
    using Microsoft.AspNetCore.Http.HttpResults;

    namespace MuddiestMoment.Api.Student.Endpoints;

    public static class StudentAddsMoment
    {
        public static async Task<Ok<StudentMomentResponseModel>> AddMoment(
            StudentMomentCreateModel request, IDocumentSession session)
        {
            var response = new StudentMomentResponseModel
            {
                Id = Guid.NewGuid(),
                Title = request.Title,
                Description = request.Description,
                CreatedOn = DateTimeOffset.UtcNow,
                AddedBy = "fake user" // TODO: We need the ID of the actual user that made this request.
            };

            // saving it to the database.
            var entity = new StudentMomentEntity
            {
                // mapping 
                Id = response.Id,
                Title = response.Title,
                Description = response.Description,
                AddedBy = response.AddedBy,
                CreatedOn = response.CreatedOn
            };

            // will vary depending on what libarary/database you are using.
            session.Store(entity); // this connection running this code wants to as part of this operation,
            // store this entity.
            // list of things that this "means" - Transaction -- all of this has to happen or none of it does.

            await session.SaveChangesAsync();


            return TypedResults.Ok(response);
        }
    }
    ```